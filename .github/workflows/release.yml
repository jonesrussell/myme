name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          $ver = $env:GITHUB_REF -replace '^refs/tags/v', ''
          echo "VERSION=$ver" >> $env:GITHUB_OUTPUT

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.10.1'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2022_64'
          dir: ${{ github.workspace }}/qt-install
          cache: true

      - name: Set Qt path
        shell: pwsh
        run: |
          # aqtinstall installs to dir/version/arch; prefer action env if set
          $qtRoot = if ($env:QT_ROOT_DIR) {
            $env:QT_ROOT_DIR -replace '/', '\'
          } else {
            Join-Path $env:GITHUB_WORKSPACE "qt-install\6.10.1\win64_msvc2022_64"
          }
          if (-not (Test-Path $qtRoot)) {
            Write-Error "Qt root not found: $qtRoot"
            exit 1
          }
          echo "QT_ROOT=$qtRoot" >> $env:GITHUB_ENV

      - name: Build Rust (with MSVC and Qt env)
        run: |
          $vsPath = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath
          if (-not $vsPath) { Write-Error "Visual Studio with C++ tools not found"; exit 1 }
          $vsDevCmd = Join-Path $vsPath "Common7\Tools\VsDevCmd.bat"
          if (-not (Test-Path $vsDevCmd)) { Write-Error "VsDevCmd.bat not found"; exit 1 }
          $env:CMAKE_PREFIX_PATH = $env:QT_ROOT
          $env:Qt6_DIR = "$env:QT_ROOT\lib\cmake\Qt6"
          $env:QMAKE = "$env:QT_ROOT\bin\qmake.exe"
          cmd /c "`"$vsDevCmd`" -arch=amd64 -no_logo && set CMAKE_PREFIX_PATH=$env:QT_ROOT && set Qt6_DIR=$env:Qt6_DIR && set QMAKE=$env:QMAKE && cargo build --release"

      - name: Configure CMake
        run: |
          cmake -B build -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_PREFIX_PATH="$env:QT_ROOT" `
            -DQt6_DIR="$env:QT_ROOT\lib\cmake\Qt6"

      - name: Build Qt Application
        run: cmake --build build --config Release

      - name: Create distribution directory
        run: |
          New-Item -ItemType Directory -Force -Path dist/myme
          Copy-Item build/Release/myme-qt.exe dist/myme/

      - name: Bundle Qt dependencies
        run: |
          & "$env:QT_ROOT\bin\windeployqt.exe" --release --no-translations --qmldir crates/myme-ui/qml dist/myme/myme-qt.exe

      - name: Create portable ZIP
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          Compress-Archive -Path dist/myme/* -DestinationPath "dist/myme-v${env:VERSION}-windows.zip"

      - name: Install Inno Setup
        run: choco install innosetup -y

      - name: Build Installer
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" /DAppVersion=$env:VERSION installer/myme.iss

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        with:
          name: windows-release
          path: |
            dist/myme-v${{ steps.version.outputs.VERSION }}-windows.zip
            dist/myme-${{ steps.version.outputs.VERSION }}-windows-setup.exe

  release:
    needs: build-windows
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-release
          path: dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            dist/myme-v${{ steps.version.outputs.VERSION }}-windows.zip
            dist/myme-${{ steps.version.outputs.VERSION }}-windows-setup.exe
          draft: false
          fail_on_unmatched_files: true
          prerelease: ${{ contains(github.ref, '-alpha') || contains(github.ref, '-beta') || contains(github.ref, '-rc') }}
